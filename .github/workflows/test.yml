name: test

on:
  - push

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64_windows_gnu
          - aarch64_windows_gnu
          - x86_64_linux_gnu
          - x86_64_linux_musl
          - aarch64_linux_gnu
          - aarch64_linux_musl
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v5
      - name: Install cross-compilation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-mingw-w64-x86-64 \
            gcc-mingw-w64-i686 \
            gcc-aarch64-linux-gnu \
            gcc-arm-linux-gnueabihf \
            musl-tools
      - uses: jiro4989/setup-nim-action@v2
        with:
          nim-version: 2.2.x
          nim-install-directory: nim
          parent-nim-install-directory: /opt
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - run: nimble install
      - run: nimble build -d:${{ matrix.target }} --verbose
      - run: ls -al
      - run: mv ./cross ./cross-${{ matrix.target }}
      - uses: actions/upload-artifact@v4
        with:
          name: cross-${{ matrix.target }}
          path: ./cross-${{ matrix.target }}
      - run: file ./cross-${{ matrix.target }}
      - run: objdump -f ./cross-${{ matrix.target }} || true
      - run: objdump -h ./cross-${{ matrix.target }} || true
      - run: objdump -p ./cross-${{ matrix.target }} || true
      - run: readelf -h ./cross-${{ matrix.target }} || true
      - run: ldd ./cross-${{ matrix.target }} || true
      - run: strings ./cross-${{ matrix.target }} | head -20 || true
